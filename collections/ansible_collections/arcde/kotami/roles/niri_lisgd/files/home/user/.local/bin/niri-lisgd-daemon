#!/usr/bin/env bash

# Function for automatic touch device detection
detect_touch_device() {
    echo "Searching for touch devices..." >&2

    # Search for devices by patterns, excluding stylus
    local patterns=(
        "/dev/input/by-id/*Touchscreen*event*"
        "/dev/input/by-id/*touch*event*"
    )

    for pattern in "${patterns[@]}"; do
        for device in $pattern; do
            # Exclude stylus devices by name
            if [[ "$device" != *"mouse"* ]] && \
               [[ "$device" != *"stylus"* ]] && \
               [[ "$device" != *"pen"* ]] && \
               [ -e "$device" ] && [ -r "$device" ]; then
                echo "Found device: $device" >&2
                echo "$device"
                return 0
            fi
        done
    done

    echo "Error: No touch devices found" >&2
    return 1
}

# Main execution
main() {
    local device="$1"

    # Use manual device if provided, otherwise auto-detect
    if [ -n "$device" ]; then
        echo "Using manually specified device: $device" >&2
        DEVICE="$device"
    else
        echo "Auto-detecting touch device..." >&2
        DEVICE=$(detect_touch_device)
        if [ $? -ne 0 ] || [ -z "$DEVICE" ]; then
            echo "Error: Failed to auto-detect compatible touch device" >&2
            exit 1
        fi
        echo "Auto-detected compatible device: $DEVICE" >&2
    fi

    # Verify device exists and is readable
    if [ ! -r "$DEVICE" ]; then
        echo "Error: Device $DEVICE is not accessible" >&2
        exit 1
    fi

    # Start lisgd with gestures
    exec lisgd -d "$DEVICE" -t 10 -T 5 \
        -g "1,RL,R,*,R,niri msg action focus-column-right" \
        -g "1,LR,L,*,R,niri msg action focus-column-left" \
        -g "1,DU,B,*,R,niri msg action open-overview"
}

# Parse command line arguments
case "${1:-}" in
    -d|--device)
        main "$2"
        ;;
    "")
        main ""
        ;;
    *)
        echo "Usage: $0 [-d DEVICE_PATH]"
        echo "  -d, --device  Use specified device instead of auto-detection"
        exit 1
        ;;
esac
