#!/usr/bin/env bash

# Main monitoring function
monitor_lid_events() {
    echo "Starting lid switch monitor" >&2

    while true; do
        # Monitor libinput events for switch toggle
        libinput debug-events | while read -r line; do
            if [[ "$line" =~ SWITCH_TOGGLE.*switch.*lid.*state.0 ]]; then
                echo "Detected lid open event, restarting niri-lisgd.service" >&2
                logger -t niri-lisgd "Lid open detected, restarting gesture service"

                # Small delay to ensure system is ready
                sleep 1

                # Restart the main service
                systemctl --user restart niri-lisgd.service
            fi
        done

        # If we get here, the libinput command exited - wait and restart
        echo "libinput debug-events exited, restarting monitor in 5 seconds" >&2
        sleep 5
    done
}

# Start monitoring
monitor_lid_events
