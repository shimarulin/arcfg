#!/usr/bin/env bash

# Checking arguments
if [ $# -ne 1 ]; then
    echo "Usage: $0 <device_path>"
    echo "Example: $0 /dev/input/by-id/usb-ELAN_Touchscreen-event-if00"
    exit 1
fi

DEVICE="$1"

# Checking the existence of a device
if [ ! -e "$DEVICE" ]; then
    echo "Error: Device $DEVICE does not exist"
    exit 1
fi

stop_lisgd() {
    pkill -f "lisgd -d $DEVICE" 2>/dev/null
}

start_lisgd() {
    # Terminate lisgd if it running
    stop_lisgd

    # Background run (&) for lisgd
    lisgd -d "$DEVICE" -t 10 -T 5 \
        -g "1,RL,R,*,R,niri msg action focus-column-right" \
        -g "1,LR,L,*,R,niri msg action focus-column-left" \
        -g "1,DU,B,*,R,niri msg action open-overview" &
}

# Init lisgd
start_lisgd

# Monitoring orientation changes
monitor-sensor | awk '/Accelerometer orientation changed:/ { print $NF; fflush(); }' | while read -r line
do
    case "$line" in
        normal|bottom-up|right-up|left-up)
            echo "Orientation changed: $line, restarting lisgd..."
            start_lisgd
            ;;
    esac
done

# Terminate lisgd when the script exits
cleanup() {
    stop_lisgd
    exit 0
}

trap cleanup EXIT
